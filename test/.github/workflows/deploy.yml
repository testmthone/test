name: Deploy to Server

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: [self-hosted, mthserver]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH and Deploy
      run: |
        # Setup SSH securely
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
        
        # Deploy with error handling
        ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e  # Exit on any error
          
          echo "ðŸš€ Starting deployment on mthserver..."
          cd /var/www/portfolio || { echo "âŒ Directory not found"; exit 1; }
          
          echo "ðŸ“¥ Pulling latest changes..."
          git pull origin main || { echo "âŒ Git pull failed"; exit 1; }
          
          echo "ðŸ”§ Running deployment script..."
          chmod +x deploy.sh
          ./deploy.sh || { echo "âŒ Deploy script failed"; exit 1; }
          
          echo "âœ… Deployment completed successfully on mthserver!"
        EOF
        
    - name: Cleanup SSH
      if: always()
      run: |
        rm -f ~/.ssh/id_rsa
        echo "ðŸ§¹ SSH cleanup completed on mthserver"